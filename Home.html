{% extends 'BlogApp\base.html' %}
{%load static%}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'styles/blog/main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'styles/blog.css' %}">
<body class="bg-light">

    <div class="container">
   <center> <h3>Form</h3> </center>
   <br />

    <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-8">
    <form id="workflow" method="POST">
        {% csrf_token %}
  <div class="form-group" >

    <label for="examplseInputEmail1">Name</label>

    <input type="text" class="form-control form-control-sm" name="name" id="name"  placeholder="Enter name" value="{{name_return}}">

  </div>
  <div class="form-group">
    <label for="exampleInputPassword1">Description</label>
    <textarea class="form-control form-control-sm" name="description" > </textarea>
  </div>
<div class="form-group">
<label >Step </label>

      <button id="appendStep" class="btn btn-primary btn-sm" style="float:right;"> Add Step</button>
      <br/>
  </div>
  <div class="form-group mydivStep">
      <div class="controls">
       <input type="text" class="form-control form-control-sm" id="stepid" name="step[]" required placeholder="Enter step" style="width:78%; display:inline;">
       <a href="#"  style="display:inline;" class="btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a>
      <a href="#" style="display:inline;" id="configBtn_0" class="btn btn-warning btn-sm active myconfigure" role="button" aria-pressed="true" onclick="getConfigBtnId(this.id)">Configure</a>
      <br/>
      <br/>
      </div>
  </div>

  <button type="submit" class="btn btn-primary">Submit</button>
</form>

      </div>
    <div class=col-sm-2></div>
    </div>
    </div>

    <div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">

    <span class="close">&times;</span>
      <div style="height:400px; width:100%; overflow:scroll;">

<div class="container">
    <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-8">
    <form id="workFlowStepDetails" method="POST">
  <div class="form-group">
      {% csrf_token %}

    <label for="examplseInputEmail1">Step Name</label>
    <input type="text" name="stepName" id="stepname" class="form-control form-control-sm"  placeholder="Step name">
      <input type="hidden" name="foldername" id="foldername" class="form-control form-control-sm"  placeholder="Step name">
    <br>
    <label for="examplseInputEmail1">Step Type</label>
    <input type="text" name="stepType" id="steptype" class="form-control form-control-sm"  placeholder="Step type">

  </div>
<div class="form-group">
<label >Operation Variable </label>

      <button id="append_Operation_Variable" class="btn btn-primary btn-sm" style="float:right;"> Add Step</button>
      <br/>
  </div>
  <div class="form-group mydiv">
      <div class="controls">
       <input type="text" name="OperationVariable[]" id="operationvariable" class="form-control form-control-sm opvar" placeholder="Enter operation variable " style="width:89.5%; display:inline;" onblur="getElementId(this.id)">  <a href="#"  style="display:inline;" class="btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a>
      <br/>
          <br/>
      </div>
  </div>
        <div class="form-group">
<label >Reader </label>

      <button id="append_Reader" class="btn btn-primary btn-sm" style="float:right;"> Add Step</button>
      <br/>
  </div>
  <div class="form-group mydivReader">
      <div class="controls">
          <select name="Select_reader[]" id="reader_0" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)">
    <option value="Select reader">Select reader</option>
    <option value="OracleDataRead(SOURCEIDENTIFIER,SOURCENAME,GETSOURCESQL)">OracleDataRead(SOURCEIDENTIFIER,SOURCENAME,GETSOURCESQL)</option>
    <option value="CSVDataRead(SOURCEIDENTIFIER,SOURCEFILENAME,FILEPATH)">CSVDataRead(SOURCEIDENTIFIER,SOURCEFILENAME,FILEPATH)</option>
    <option value="EXCELDataRead(SOURCEIDENTIFIER,SOURCEFILEPATH,PATTERN)">EXCELDataRead(SOURCEIDENTIFIER,SOURCEFILEPATH,PATTERN)</option>
    <option value="SftpRead(SOURCEREMOTESERVERNAME,SOURCEREMOTEPORTNO,SOURCEREMOTEUSERNAME,SOURCEREMOTEPASSWORD,SOURCELOCALFILEPATH,SOURCEREMOTEFILENAME)">SftpRead(SOURCEREMOTESERVERNAME,SOURCEREMOTEPORTNO,SOURCEREMOTEUSERNAME,SOURCEREMOTEPASSWORD,SOURCELOCALFILEPATH,SOURCEREMOTEFILENAME)</option>
    </select>
       <a href="#"  style="display:inline;" class="btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a>
      <br/>
          <br/>
      </div>
  </div>
        <div class="form-group">
<label >Processor </label>

      <button id="append_Processor" class="btn btn-primary btn-sm" style="float:right;"> Add Step</button>
      <br/>

  </div>
  <div class="form-group mydivProcessor">
      <div class="controls">
       <select name="selectProcessor[]" id="processor_0" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)">
    <option value="Select processor">Select processor</option>
    <option value="PythonDataProcessor(SCRIPTNAME,METHOD)">PythonDataProcessor(SCRIPTNAME,METHOD)</option>
    <option value="FileChecker(FOLDERPATH,PATTERN,SCHEDULESTOPPER)">FileChecker(FOLDERPATH,PATTERN,SCHEDULESTOPPER)</option>
    <option value="FILEMOVEPROCCESOR(SOURCEFILENAME,TARGETFILENAME,MOVETYPE,PATTERN)">FILEMOVEPROCCESOR(SOURCEFILENAME,TARGETFILENAME,MOVETYPE,PATTERN)</option>
    </select>  <a href="#"  style="display:inline;" class="btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a>
      <br/>
          <br/>
      </div>
  </div>
        <div class="form-group">
<label >Writer</label>

      <button id="append_Writer" class="btn btn-primary btn-sm" style="float:right;"> Add Step</button>
      <br/>

  </div>
  <div class="form-group mydivWriter">
      <div class="controls">
       <select name="selectWriter[]" id="writer_0" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)">
    <option value="Select Reader">Select Writer</option>
    <option value="EXCELDATAWRITER(INPUTSOURCEFORWRITER,FILENAME,FILEPATH,SHEETNAME,HEADERREQUIRED)">EXCELDATAWRITER(INPUTSOURCEFORWRITER,FILENAME,FILEPATH,SHEETNAME,HEADERREQUIRED)</option>
    <option value="CSVDataWrite(INPUTSOURCEFORWRITER,TARGETFILENAME,TARGETDELIMITER,FILEPATH)">CSVDataWrite(INPUTSOURCEFORWRITER,TARGETFILENAME,TARGETDELIMITER,FILEPATH)</option>
    <option value="OracleDataWrite(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST)">OracleDataWrite(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST)</option>
    <option value="OracleDataDelInsert(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST,DELETEKEY)">OracleDataDelInsert(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST,DELETEKEY)</option>
    </select>  <a href="#"  style="display:inline;" class="btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a>
      <br/>
          <br/>
      </div>
  </div>
  <button type="submit" class="btn btn-primary">Submit</button>
</form>

      </div>
    <div class=col-sm-2></div>
    </div>
    </div>


      </div>
  </div>

</div>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->


    <script type="text/javascript">

var count=0;
var uniqueID=0;
var opvarId=0;
var readerId=0;
var processorId=0;
var writerId=0;
var configBtnId='';
var stepDetails = new Map();
var myMap = new Map();
var opvarMap;
var readerMap;
var processorMap;
var writerMap;



function openConfigure(configId){
    if(stepDetails.has(configId)) {
        var configStepDetails = stepDetails.get(configId);
        var sName = configStepDetails.get("stepName");
        var sType = configStepDetails.get("stepType");
        var sOp = new Map();
        sOp = configStepDetails.get("opVariable");
        //var sReader = configStepDetails.get("reader");
        var sReader = new Map();
        sReader = configStepDetails.get("reader");
        var sProcessor = new Map();
        sProcessor = configStepDetails.get("processor");
        var sWriter = new Map();
        sWriter = configStepDetails.get("writer");

        document.getElementById("stepname").value = sName;
        document.getElementById("steptype").value = sType;
       // document.getElementById("operationvariable").value = sOp;
        var sOpKeys = sOp.entries();
        for(var keys of sOpKeys){
            //for(var i=0;i<keys.length;i++){
                document.getElementById(keys[0]).value = keys[1];
            //}
        }
        var sReaderKeys = sReader.entries();
        for(var keys of sReaderKeys){
            //for(var i=0;i<keys.length;i++){
                document.getElementById(keys[0]).value = keys[1];
            //}
        }
         var sProcessorKeys = sProcessor.entries();
        for(var keys of sProcessorKeys){
            //for(var i=0;i<keys.length;i++){
                document.getElementById(keys[0]).value = keys[1];
            //}
        }
        var sWriterKeys = sWriter.entries();
        for(var keys of sWriterKeys){
            //for(var i=0;i<keys.length;i++){
                document.getElementById(keys[0]).value = keys[1];
            //}
        }
        //document.getElementById("reader").value = sReader;
        //document.getElementById("processor").value = sProcessor;
        //document.getElementById("writer").value = sWriter;
    }
}

function getElementId(id){
    var elemData = document.getElementById(id).value;
    createElemMap(id, elemData);
}

function createElemMap(mapKey, keyValue){
    if(mapKey.substr(0,2) === 'op'){
        if(opvarMap === undefined){
        opvarMap = new Map();
    }
        opvarMap.set(mapKey, keyValue);
    }else if(mapKey.substr(0,2) === 're'){
        if(readerMap === undefined){
        readerMap = new Map();
    }
        readerMap.set(mapKey, keyValue);
    }
    if(mapKey.substr(0,2) === 'pr'){
        if(processorMap === undefined){
        processorMap = new Map();
    }
        processorMap.set(mapKey, keyValue);
    }else if(mapKey.substr(0,2) === 'wr'){
        if(writerMap === undefined){
        writerMap = new Map();
    }
        writerMap.set(mapKey, keyValue);
    }
}

function getConfigBtnId(id){
    configBtnId = id;
}

$(document).ready( function () {
        console.log(configBtnId);

        $(document).on('click', '.myconfigure', function() {
        stepid=$(this).parent().find('input').val();
        document.getElementById("workFlowStepDetails").reset();
        {% comment %}var configureElem = document.getElementsByClassName("myconfigure")[0].id;{% endcomment %}
        {% comment %}console.log(configureElem);{% endcomment %}
        if(stepDetails.size >= 1 && configBtnId === 'configBtn_0') {
            openConfigure(configBtnId);
        }else{
            if(stepDetails.size > 1){
                openConfigure(configBtnId);
                //console.log(sName);
            }
        }
        // below code is modal code

        var modal = document.getElementById("myModal");

        // Get the button that opens the modal


        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        modal.style.display = "block";
        name = $('#name').val();

        document.getElementById("stepname").value = stepid;
        document.getElementById("foldername").value = name;
        document.getElementById("name").value = name;

        //code end
        });

        $("#appendStep").click( function(e) {
         e.preventDefault()
            uniqueID = uniqueID+1;
        $(".mydivStep").append('<div class="controls"><input type="text" name="step[]" required class="form-control form-control-sm" placeholder="Enter step" style="width:78%; display:inline;">  <a href="#"  style="display:inline;" class="remove_this btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a> <button href="#" style="display:inline;" id="configBtn_' + uniqueID +'" class="btn btn-warning btn-sm active myconfigure" type=button role="button" aria-pressed="true" onclick="getConfigBtnId(this.id)">Configure</button><br/><br/></div>');
        {#$(".myconfigure").attr("id", "configBtn_"+configCount);#}

        return false;

        });

    $("#workflow").submit( function(e){
        e.preventDefault();
        $.ajax({
            type:"POST",
            url:"./Home/ajax/workflow/submit",
            data:stepDetails,
            dataType:"json",
            success:function(data){
                var data = data.get("configBtn_1");
                var stepName = data.get("stepName");
                var stepType = data.get("stepType");
                console.log("Step Name : "+stepName+" :::: Step Type : "+stepType);
                alert(data);
            },
            error:function(){
                alert("data not received");
            }
        });
    });

    $("#workFlowStepDetails").submit( function(e) {
        e.preventDefault();
        console.log("Count : "+count);

    var stepname = $('#stepname').val();
    var steptype = $('#steptype').val();
    var operationVariable = opvarMap;
    var reader = readerMap;
    var processor = processorMap;
    var writer = writerMap;
    //var processor = $('#processor').val();
    //var writer = $('#writer').val();

    if(myMap.size !== 0 && stepname !== myMap.get("stepName")) {
        myMap = new Map();
    }
myMap.set("stepName", stepname);
myMap.set("stepType", steptype);
myMap.set("opVariable", operationVariable);
myMap.set("reader", reader);
myMap.set("processor", processor);
myMap.set("writer", writer);
{% comment %}stepArray[count] = myMap;{% endcomment %}
        stepDetails.set(configBtnId, myMap);
count=count+1;
console.log("New Count : "+count);
modal.style.display = "none";
    });

    $(document).on('click', '.remove_this', function() {
        jQuery(this).parent().remove();
        return false;
        });

    $("input[type=submit]").click(function(e) {
       e.preventDefault();
       $(this).next("[name=textbox]")
       .val(
        $.map($(".inc :text"), function(el) {
          return el.value
        }).join(",\n")
      )
    })
  });
/*
function blockModel() {
  modal.style.display = "block";
  name = $('#name').val();
      //  stepid = $('#stepid').val();
        document.getElementById("stepname").value = stepid;
        document.getElementById("foldername").value = name;
}
*/
var modal = document.getElementById("myModal");
var span = document.getElementsByClassName("close")[0];
// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";

}


// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

// Down code for configure code

jQuery(document).ready( function () {

        $("#append_Operation_Variable").click( function(e) {
         e.preventDefault();
         opvarId = opvarId + 1;
         //opvarMap = new Map();
        $(".mydiv").append('<div class="controls"><input type="text" name="OperationVariable[]"  id="operationvariable_' + opvarId +'" class="form-control form-control-sm opvar" placeholder="Enter operation variable" style="width:89.5%; display:inline;" onblur="getElementId(this.id)">  <a href="#"  style="display:inline;" class="remove_this btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a> <br/><br/></div>');
        return false;
        });

        $("#append_Reader").click( function(e) {
         e.preventDefault();
         readerId = readerId + 1;
        $(".mydivReader").append('<div class="controls"><select name="Select_reader[]" id="reader_' + readerId +'" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)"><option value="Select Reader">Select Reader</option><option value="OracleDataRead(SOURCEIDENTIFIER,SOURCENAME,GETSOURCESQL)">OracleDataRead(SOURCEIDENTIFIER,SOURCENAME,GETSOURCESQL)</option><option value="CSVDataRead(SOURCEIDENTIFIER,SOURCEFILENAME,FILEPATH)">CSVDataRead(SOURCEIDENTIFIER,SOURCEFILENAME,FILEPATH)</option><option value="EXCELDataRead(SOURCEIDENTIFIER,SOURCEFILEPATH,PATTERN)">EXCELDataRead(SOURCEIDENTIFIER,SOURCEFILEPATH,PATTERN)</option><option value="SftpRead(SOURCEREMOTESERVERNAME,SOURCEREMOTEPORTNO,SOURCEREMOTEUSERNAME,SOURCEREMOTEPASSWORD,SOURCELOCALFILEPATH,SOURCEREMOTEFILENAME)">SftpRead(SOURCEREMOTESERVERNAME,SOURCEREMOTEPORTNO,SOURCEREMOTEUSERNAME,SOURCEREMOTEPASSWORD,SOURCELOCALFILEPATH,SOURCEREMOTEFILENAME)</option></select>  <a href="#"  style="display:inline;" class="remove_this btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a> <br/><br/></div>');
        return false;
        });

        $("#append_Processor").click( function(e) {
         e.preventDefault();
         processorId = processorId + 1;
        $(".mydivProcessor").append('<div class="controls"><select name="selectProcessor[]" id="processor_' + processorId +'" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)"><option value="Select processor">Select processor</option><option value="PythonDataProcessor(SCRIPTNAME,METHOD)">PythonDataProcessor(SCRIPTNAME,METHOD)</option><option value="FileChecker(FOLDERPATH,PATTERN,SCHEDULESTOPPER)">FileChecker(FOLDERPATH,PATTERN,SCHEDULESTOPPER)</option><option value="FILEMOVEPROCCESOR(SOURCEFILENAME,TARGETFILENAME,MOVETYPE,PATTERN)">FILEMOVEPROCCESOR(SOURCEFILENAME,TARGETFILENAME,MOVETYPE,PATTERN)</option></select>  <a href="#"  style="display:inline;" class="remove_this btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a> <br/><br/></div>');
        return false;
        });

        $("#append_Writer").click( function(e) {
         e.preventDefault();
         writerId = writerId + 1;
        $(".mydivWriter").append('<div class="controls"><select name="selectWriter[]" id="writer_' + writerId +'" class="form-control form-control-sm" style="width:89.5%; display:inline;" onblur="getElementId(this.id)"><option value="Select Writer">Select writer</option><option value="EXCELDATAWRITER(INPUTSOURCEFORWRITER,FILENAME,FILEPATH,SHEETNAME,HEADERREQUIRED)">EXCELDATAWRITER(INPUTSOURCEFORWRITER,FILENAME,FILEPATH,SHEETNAME,HEADERREQUIRED)</option><option value="CSVDataWrite(INPUTSOURCEFORWRITER,TARGETFILENAME,TARGETDELIMITER,FILEPATH)">CSVDataWrite(INPUTSOURCEFORWRITER,TARGETFILENAME,TARGETDELIMITER,FILEPATH)</option><option value="OracleDataWrite(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST)">OracleDataWrite(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST)</option><option value="OracleDataDelInsert(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST,DELETEKEY)">OracleDataDelInsert(INPUTSOURCE,TARGETNAME,TARGETTABLENAME,TARGETCOLUMNLIST,DELETEKEY)</option></select>  <a href="#"  style="display:inline;" class="remove_this btn btn-danger btn-sm active" role="button" aria-pressed="true">Remove</a> <br/><br/></div>');
        return false;
        });

    jQuery(document).on('click', '.remove_this', function() {
        jQuery(this).parent().remove();
        return false;
        });
    $("input[type=submit]").click(function(e) {
      e.preventDefault();
      $(this).next("[name=textbox]")
      .val(
        $.map($(".inc :text"), function(el) {
          return el.value
        }).join(",\n")
      )
    })
  });

</script>

</body>

{% endblock %}